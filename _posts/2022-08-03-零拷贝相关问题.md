---
title: 零拷贝相关问题
author: LanXuage
date: 2022-08-03 16:32:03 +0800
categories: [零拷贝]
tags: [零拷贝, 直接网卡访问技术, DMA, 直接内存访问技术, sendfile, mmap, 用户态, 内核态, 用户空间, 内核空间]
---

## 一、基础知识

- 物理内存：内存条。
- 虚拟内存：通过内存管理技术实现的一段连续完整的虚拟内存地址空间，可能实际在物理内存上的存储是碎片化分散的。
- 用户空间：系统划分给每个进程运行的虚拟内存地址空间范围，每个进程独享，进程间隔离，`32`位和`64`位范围不同，一般与内核空间成`3:1`的比例。
- 内核空间：系统划分给自身内核运行的虚拟内存地址空间范围，系统内核独享，进程间共享。
- 系统调用：内核向上层提供的一组通用的内核资源访问接口。
- 用户态：代码的`CPU`执行特权级为`R3`，只能访问用户空间内的资源。
- 内核态：代码的`CPU`执行特权级为`R0`，能访问系统的所有资源。
- 上下文切换：进程通过系统调用成功从用户态切换到内核态或者从内核态切换回用户态都称为上下文切换。

## 二、`DMA`拷贝

`DMA`(`Direct Memory Access`)：直接内存访问技术；是一种允许外围设备（硬件子系统）直接访问系统主内存的机制。也就是说，基于`DMA`访问方式，系统主内存与硬盘或网卡之间的数据传输可以绕开`CPU`的全程调度（`CPU`只需要发送指令简单调度外围设备的硬件子系统，数据的拷贝和传输交由外围设备的硬件子系统来处理）。目前大多数的硬件设备，包括磁盘控制器、网卡、显卡以及声卡等都支持`DMA`技术。该技术的优点是实现了`CPU`和数据`DMA`拷贝的并行，加快了整体处理速度。可以使用下面的命令来查看是否支持`DMA`。
```sh
ethtool -k eth0 | grep gather
```

## 三、传统`I/O`拷贝

传统的`I/O`拷贝是通过`read`和`write`两个系统调用来实现的。主要步骤如下：

1、进程调用`read`，进程由用户态切换到内核态。

2、`CPU`调度输入设备进行`DMA`将数据从输入设备拷贝到内核空间的内核缓冲区中。

3、`CPU`将内核缓冲区中的数据拷贝到用户空间的用户缓冲区中，随后进程由内核态切换回用户态。

4、进程调用`write`，进程由用户态切换到内核态。

5、`CPU`将用户缓冲区的数据拷贝到内核空间的内核缓冲区中。

6、`CPU`调度输出设备进行`DMA`将数据从内核缓冲区中拷贝到输出设备中。

整个过程涉及`4`次上下文切换和`4`次拷贝（`2`次`CPU`拷贝，`2`次`DMA`拷贝）。

## 四、零拷贝技术

### 4.1、介绍

零拷贝（`Zero-copy`）技术指在计算机执行操作时，`CPU`不需要先将数据从一个内存区域复制到另一个内存区域，从而可以减少上下文切换以及`CPU`的拷贝时间。它的作用是在数据报从网络设备到用户程序空间传递的过程中，减少数据拷贝次数，减少系统调用，实现`CPU`的零参与，彻底消除`CPU`在这方面的负载。实现零拷贝用到的最主要技术是`DMA`数据传输技术和内存区域映射技术。

- 零拷贝机制可以减少数据在内核缓冲区和用户进程缓冲区之间反复的`I/O`拷贝操作。
- 零拷贝机制可以减少用户进程地址空间和内核地址空间之间因为上下文切换而带来的`CPU`开销。

在`Linux`中零拷贝技术主要有`3`种实现思路：用户态直接`I/O`、减少数据拷贝次数以及写时复制技术。

- 用户态直接`I/O`：应用程序可以直接访问硬件存储，操作系统内核只是辅助数据传输。这种方式依旧存在用户空间和内核空间的上下文切换，硬件上的数据直接拷贝至了用户空间，不经过内核空间。因此，直接`I/O`不存在内核空间缓冲区和用户空间缓冲区之间的数据拷贝。
- 减少数据拷贝次数：在数据传输过程中，避免数据在用户空间缓冲区和系统内核空间缓冲区之间的`CPU`拷贝，以及数据在系统内核空间内的`CPU`拷贝，这也是当前主流零拷贝技术的实现思路。
- 写时复制技术：写时复制指的是当多个进程共享同一块数据时，如果其中一个进程需要对这份数据进行修改，那么将其拷贝到自己的进程地址空间中，如果只是数据读取操作则不需要进行拷贝操作。


<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="pv-cache-enabled" content="false">
<meta name="generator" content="Jekyll v4.2.0">
<meta property="og:title" content="Kubernetes(K8s)集群搭建">
<meta name="author" content="LanXuage">
<meta property="og:locale" content="zh_CN">
<meta name="description" content="节点硬件配置要求">
<meta property="og:description" content="节点硬件配置要求">
<link rel="canonical" href="/posts/Kubernetes(K8s)%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/">
<meta property="og:url" content="/posts/Kubernetes(K8s)%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/">
<meta property="og:site_name" content="LanXuage">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-09-29T09:48:48+08:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Kubernetes(K8s)集群搭建">
<meta name="twitter:site" content="@LanXuage">
<meta name="twitter:creator" content="@LanXuage">
<meta name="google-site-verification" content="google_meta_tag_verification"> <script type="application/ld+json"> {"author":{"@type":"Person","name":"LanXuage"},"description":"节点硬件配置要求","headline":"Kubernetes(K8s)集群搭建","dateModified":"2022-09-29T09:48:48+08:00","datePublished":"2022-09-29T09:48:48+08:00","url":"/posts/Kubernetes(K8s)%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Kubernetes(K8s)%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"},"@context":"https://schema.org"}</script><title>Kubernetes(K8s)集群搭建 | LanXuage</title>
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon">
<link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png">
<link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png">
<link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/manifest.json">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
<link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials">
<link rel="dns-prefetch" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous">
<link rel="dns-prefetch" href="https://www.googletagmanager.com">
<link rel="preconnect" href="cdn.jsdelivr.net">
<link rel="dns-prefetch" href="cdn.jsdelivr.net">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
</head>
<body data-spy="scroll" data-target="#toc">
<div id="sidebar" class="d-flex flex-column align-items-end">
<div class="profile-wrapper text-center">
<div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/image/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a>
</div>
<div class="site-title mt-3"> <a href="/">LanXuage</a>
</div>
<div class="site-subtitle font-italic">Bad times make a good man.</div>
</div>
<ul class="w-100">
<li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a>
</li>
<li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a>
</li>
<li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a>
</li>
<li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a>
</li>
<li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a>
</li>
</ul>
<div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/LanXuage" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/LanXuage" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href%20=%20'mailto:'%20+%20%5B'zx1456817554','gmail.com'%5D.join('@')" aria-label="email" class="order-5"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6"> <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span>
</div>
</div>
<div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Kubernetes(K8s)集群搭建</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div>
<i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span>
</div></div>
<div id="main-wrapper">
<div id="main">
<div class="row">
<div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
<h1 data-toc-skip>Kubernetes(K8s)集群搭建</h1>
<div class="post-meta text-muted d-flex flex-column">
<div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Sep 29, 2022, 9:48 AM +0800"> Sep 29 <i class="unloaded">2022-09-29T09:48:48+08:00</i> </span> by <span class="author"> LanXuage </span>
</div>
<div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1145 words">6 min</span>
</div>
</div>
<div class="post-content">
<h1 id="节点硬件配置要求">节点硬件配置要求</h1>
<ul>
<li>不能使用交换分区: <code class="language-plaintext highlighter-rouge">swapoff /path/to/endpoint</code>
</li>
<li>物理内存不能少于1700M（除去系统占用，建议设置为2G）: <code class="language-plaintext highlighter-rouge">free -m</code>
</li>
<li>CPU核心数不能少于2: <code class="language-plaintext highlighter-rouge">lscpu</code>
</li>
</ul>
<h1 id="部署过程">部署过程</h1>
<h2 id="1确保每个节点上-mac-地址和-product_uuid-的唯一性">1、确保每个节点上 MAC 地址和 product_uuid 的唯一性</h2>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre><span class="c"># 查看 MAC 地址</span>
ip <span class="nb">link
</span>ifconfig <span class="nt">-a</span>

<span class="c"># 查看 product_uuid </span>
<span class="nb">sudo cat</span> /sys/class/dmi/id/product_uuid
</pre></td>
</tr></tbody></table></code></div></div>
<h2 id="2允许-iptables-桥接流量">2、允许 iptables 桥接流量</h2>
<h3 id="可选21确保-br_netfilter-模块被加载">（可选）2.1、确保 br_netfilter 模块被加载</h3>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td>
<td class="rouge-code"><pre><span class="c"># 查看，内核比较新的系统可能没有任何显示</span>
lsmod | <span class="nb">grep </span>br_netfilter

<span class="c"># 执行显式加载</span>
<span class="nb">sudo </span>modprobe br_netfilter
</pre></td>
</tr></tbody></table></code></div></div>
<h3 id="22确保在-sysctl-配置中将-netbridgebridge-nf-call-iptables-设置为-1">2.2、确保在 sysctl 配置中将 net.bridge.bridge-nf-call-iptables 设置为 1</h3>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
<td class="rouge-code"><pre><span class="c"># 添加需要的模块，其中 ip_vs 相关模块为 kubeProxy 模式为 ipvs 时所需要加载的模块</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/modules-load.d/k8s.conf
br_netfilter
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack
</span><span class="no">EOF

</span><span class="c"># 添加 IP 转发和桥接</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
</span><span class="no">EOF

</span><span class="c"># 显式生效</span>
<span class="nb">sudo </span>sysctl <span class="nt">--system</span>
</pre></td>
</tr></tbody></table></code></div></div>
<h2 id="3安装容器运行时docker或者containerd">3、安装容器运行时（docker或者containerd）</h2>
<h3 id="31docker-安装">3.1、docker 安装</h3>
<blockquote><p>docker 本身也是采用的 containerd 容器运行时</p></blockquote>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre>curl <span class="nt">-fsSL</span> https://get.docker.com | bash <span class="nt">-s</span> docker <span class="nt">--mirror</span> Aliyun
</pre></td>
</tr></tbody></table></code></div></div>
<h3 id="32containerd-安装">3.2、containerd 安装</h3>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="c"># 可在源码仓库(https://github.com/containerd/containerd/releases)处下载最新的 cri 压缩包直接于解压到根目录即可。</span>
<span class="nb">tar</span> <span class="nt">-C</span> / <span class="nt">-zxvf</span> cri-containerd-1.6.7-linux-amd64.tar.gz
<span class="c"># 初始化配置文件</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /etc/containerd
containerd config default <span class="o">&gt;</span> /etc/containerd/config.toml
<span class="c"># 启动并设为自启</span>
systemctl <span class="nb">enable </span>containerd <span class="nt">--now</span>
</pre></td>
</tr></tbody></table></code></div></div>
<h2 id="4使用阿里云源安装-kubeletkubeadm-和-kubectl">4、使用阿里云源安装 kubelet、kubeadm 和 kubectl。</h2>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td>
<td class="rouge-code"><pre>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> apt-transport-https
curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt;/etc/apt/sources.list.d/kubernetes.list
deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
</span><span class="no">EOF
</span>apt-get update
apt-get <span class="nb">install</span> <span class="nt">-y</span> kubelet kubeadm kubectl
apt-get <span class="nb">install</span> <span class="nt">-y</span> ipvsadm ipset <span class="c"># ipvs</span>
<span class="c"># 一般情况都会设为开机启动</span>
systemctl <span class="nb">enable </span>kubelet
</pre></td>
</tr></tbody></table></code></div></div>
<h2 id="pre-5生成-init-配置文件">pre-5、生成 init 配置文件</h2>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre>kubeadm config print init-defaults <span class="nt">--component-configs</span> KubeletConfiguration <span class="nt">--component-configs</span> KubeProxyConfiguration <span class="o">&gt;</span> kubeadm-config.yml
</pre></td>
</tr></tbody></table></code></div></div>
<h3 id="基本配置">基本配置</h3>
<div class="language-yml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="c1"># 配置当前节点的 IP ，即集群 kube-apiserver 的监听地址，也就是 master 节点</span>
<span class="na">localAPIEndpoint</span><span class="pi">:</span>
  <span class="na">advertiseAddress</span><span class="pi">:</span> <span class="s">172.29.9.51</span>  

<span class="c1"># 检查criSocket 配置项，如果使用containerd运行时的话正常内容应该是containerd的sock文件（unix:///var/run/containerd/containerd.sock), docker默认为：/var/run/dockershim.sock</span>
<span class="na">nodeRegistration</span><span class="pi">:</span>
  <span class="na">criSocket</span><span class="pi">:</span> <span class="s">/var/run/dockershim.sock</span>
</pre></td>
</tr></tbody></table></code></div></div>
<h3 id="确保关闭防火墙">确保关闭防火墙</h3>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre><span class="c"># 查看</span>
ufw status
<span class="c"># 关闭</span>
ufw disable
</pre></td>
</tr></tbody></table></code></div></div>
<h2 id="5配置-cgroup-驱动">5、配置 cgroup 驱动</h2>
<blockquote><p>确保容器运行时的 cgroup 驱动和 kubelet 的 cgroup 驱动一致。官方推荐使用 systemd。</p></blockquote>
<h3 id="51配置容器运行时-cgroup-驱动">5.1、配置容器运行时 cgroup 驱动</h3>
<h4 id="docker">docker</h4>
<p>docker 配置方式：修改 docker 配置文件 <code class="language-plaintext highlighter-rouge">/etc/docker/daemon.json</code>，添加下面内容已启用systemd，</p>
<div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"exec-opts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"native.cgroupdriver=systemd"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td>
</tr></tbody></table></code></div></div>
<p>查看 docker 当前使用的 cgroup 驱动</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre>docker info
</pre></td>
</tr></tbody></table></code></div></div>
<h4 id="containerd">containerd</h4>
<p>修改 <code class="language-plaintext highlighter-rouge">/etc/containerd/config.toml</code> 配置文件，</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td>
<td class="rouge-code"><pre><span class="o">[</span>plugins.<span class="s2">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runc]
  ...
  <span class="o">[</span>plugins.<span class="s2">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runc.options]
    SystemdCgroup <span class="o">=</span> <span class="nb">true</span>  <span class="c"># 将该项改为true，默认为false</span>
    ....

<span class="c"># 可以采用sed命令</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/SystemdCgroup = false/SystemdCgroup = true/g"</span> /etc/containerd/config.toml
</pre></td>
</tr></tbody></table></code></div></div>
<h3 id="52配置-kubelet-的-cgroup-驱动">5.2、配置 kubelet 的 cgroup 驱动</h3>
<p>kubeadm 支持在执行 kubeadm init 时，传递一个 KubeletConfiguration 结构体。 KubeletConfiguration 包含 cgroupDriver 字段，可用于控制 kubelet 的 cgroup 驱动。如果用户没有在 KubeletConfiguration 中设置 cgroupDriver 字段， kubeadm init 会将它设置为默认值 systemd。</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre><span class="c1"># kubeadm-config.yaml</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">KubeletConfiguration</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kubelet.config.k8s.io/v1beta1</span>
<span class="na">cgroupDriver</span><span class="pi">:</span> <span class="s">systemd</span> <span class="c1"># 确保这一项为所需的cgroup</span>
</pre></td>
</tr></tbody></table></code></div></div>
<h3 id="可选53配置ipvs">（可选）5.3、配置IPVS</h3>
<div class="language-yml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td>
<td class="rouge-code"><pre><span class="c1"># kubeadm-config.yaml</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">KubeProxyConfiguration</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kubeproxy.config.k8s.io/v1alpha1</span>
<span class="na">mode</span><span class="pi">:</span> <span class="s">ipvs</span> <span class="c1"># 使用ipvs</span>
</pre></td>
</tr></tbody></table></code></div></div>
<h3 id="54配置镜像拉取的仓库地址">5.4、配置镜像拉取的仓库地址</h3>
<p>配置集群初始化时使用的镜像仓库地址，默认为 <code class="language-plaintext highlighter-rouge">k8s.gcr.io</code> ，国内可换成 <code class="language-plaintext highlighter-rouge">registry.aliyuncs.com/k8sxio</code> 或者 <code class="language-plaintext highlighter-rouge">registry.cn-hangzhou.aliyuncs.com/google_containers</code> 等地址</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="c1"># kubeadm-config.yml </span>
<span class="na">imageRepository</span><span class="pi">:</span> <span class="s">k8s.gcr.io</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterConfiguration</span>
</pre></td>
</tr></tbody></table></code></div></div>
<h3 id="可选55配置-flannel-网段">（可选）5.5、配置 flannel 网段</h3>
<div class="language-yml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre><span class="na">networking</span><span class="pi">:</span>
  <span class="na">dnsDomain</span><span class="pi">:</span> <span class="s">cluster.local</span>
  <span class="na">podSubnet</span><span class="pi">:</span> <span class="s">10.244.0.0/16</span>
  <span class="na">serviceSubnet</span><span class="pi">:</span> <span class="s">10.96.0.0/12</span>
</pre></td>
</tr></tbody></table></code></div></div>
<h3 id="可选56配置-calico-网段">（可选）5.6、配置 calico 网段</h3>
<div class="language-yml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre><span class="na">networking</span><span class="pi">:</span>
  <span class="na">dnsDomain</span><span class="pi">:</span> <span class="s">cluster.local</span>
  <span class="na">podSubnet</span><span class="pi">:</span> <span class="s">192.168.0.0/16</span>
  <span class="na">serviceSubnet</span><span class="pi">:</span> <span class="s">10.96.0.0/12</span>
</pre></td>
</tr></tbody></table></code></div></div>
<h2 id="6使用-kubeadm-创建集群">6、使用 kubeadm 创建集群</h2>
<h3 id="可选61-配置国内网络问题解决">（可选）6.1、 配置国内网络问题解决</h3>
<h4 id="配置-docker-代理">配置 docker 代理</h4>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="rouge-code"><pre><span class="nb">mkdir</span> <span class="nt">-p</span> /etc/systemd/system/docker.service.d

<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt;/etc/systemd/system/docker.service.d/proxy.conf
[Service]
Environment="HTTP_PROXY=socks5://127.0.0.1:1080" "HTTPS_PROXY=socks5://127.0.0.1:1080" "NO_PROXY=localhost,127.0.0.1,daocloud.io,docker.io"
</span><span class="no">EOF

</span>systemctl daemon-reload
systemctl restart docker
</pre></td>
</tr></tbody></table></code></div></div>
<h4 id="配置-containerd-加速仓库">配置 containerd 加速仓库</h4>
<blockquote><p>文件/etc/containerd/config.toml</p></blockquote>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre><span class="o">[</span>plugins.<span class="s2">"io.containerd.grpc.v1.cri"</span>.registry]
  <span class="o">[</span>plugins.<span class="s2">"io.containerd.grpc.v1.cri"</span>.registry.mirrors]
    <span class="o">[</span>plugins.<span class="s2">"io.containerd.grpc.v1.cri"</span>.registry.mirrors.<span class="s2">"docker.io"</span><span class="o">]</span>   <span class="c"># 可选</span>
      endpoint <span class="o">=</span> <span class="o">[</span><span class="s2">"https://{你的ID}.mirror.aliyuncs.com"</span><span class="o">]</span>                <span class="c"># 可选</span>
    <span class="o">[</span>plugins.<span class="s2">"io.containerd.grpc.v1.cri"</span>.registry.mirrors.<span class="s2">"k8s.gcr.io"</span><span class="o">]</span>
      endpoint <span class="o">=</span> <span class="o">[</span><span class="s2">"https://registry.aliyuncs.com/k8sxio"</span><span class="o">]</span>                 <span class="c"># 最好与前面 kubeadm-config.yml 初始化配置时使用的仓库地址一致。</span>
</pre></td>
</tr></tbody></table></code></div></div>
<h3 id="62拉取-k8s-所需镜像">6.2、拉取 k8s 所需镜像</h3>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre>kubeadm config images pull
</pre></td>
</tr></tbody></table></code></div></div>
<h3 id="63初始化-k8s-节点">6.3、初始化 k8s 节点</h3>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre>kubeadm init
<span class="c"># 使用配置文件</span>
kubeadm init <span class="nt">--config</span> kubeadm-config.yml | <span class="nb">tee </span>kubeadm-config.log
</pre></td>
</tr></tbody></table></code></div></div>
<h3 id="64设置-master-节点">6.4、设置 Master 节点</h3>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$HOME</span>/.kube
<span class="nb">cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
<span class="nb">chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> <span class="nv">$HOME</span>/.kube/config

<span class="c"># 可选（root）</span>
<span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf
</pre></td>
</tr></tbody></table></code></div></div>
<h3 id="65加入集群">6.5、加入集群</h3>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre>kubeadm <span class="nb">join </span>172.16.202.131:6443 <span class="nt">--token</span> yi2yxa.xg14zufpkum0ldy8 <span class="nt">--discovery-token-ca-cert-hash</span> sha256:be3398aeb75e6224ee06f8f9011e602c9dd8eaa70ed65dbb1c4a3e94cefdb463
</pre></td>
</tr></tbody></table></code></div></div>
<h3 id="66-配置网络插件">6.6 配置网络插件</h3>
<div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre>kubectl apply <span class="nt">-f</span> https://docs.projectcalico.org/manifests/calico.yaml

kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</pre></td>
</tr></tbody></table></code></div></div>
<h2 id="python-库">python 库</h2>
<p>https://github.com/kubernetes-client/python</p>
</div>
<div class="post-tail-wrapper text-muted">
<div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href="/categories/%E8%BF%90%E7%BB%B4/">运维</a>
</div>
<div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/k8s/" class="post-tag no-text-decoration">K8s</a> <a href="/tags/kubernetes/" class="post-tag no-text-decoration">Kubernetes</a> <a href="/tags/%E9%9B%86%E7%BE%A4/" class="post-tag no-text-decoration">集群</a> <a href="/tags/containerd/" class="post-tag no-text-decoration">containerd</a>
</div>
<div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
<div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div>
<div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Kubernetes(K8s)%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%20-%20LanXuage&amp;url=/posts/Kubernetes(K8s)%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Kubernetes(K8s)%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%20-%20LanXuage&amp;u=/posts/Kubernetes(K8s)%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Kubernetes(K8s)%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%20-%20LanXuage&amp;url=/posts/Kubernetes(K8s)%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span>
</div>
</div>
</div>
</div></div>
<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">
<div class="access">
<div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2">
<li><a href="/posts/nasm%E5%AD%A6%E4%B9%A0%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/">nasm学习汇编语言</a></li>
<li><a href="/posts/Kafka%E7%9A%84SSL%E5%8A%A0%E5%AF%86%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98/">Kafka的SSL加密相关问题</a></li>
</ul>
</div>
<div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/adworld/">adworld</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/reverse/">reverse</a> <a class="post-tag" href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/">攻防世界</a> <a class="post-tag" href="/tags/android-studio/">Android Studio</a> <a class="post-tag" href="/tags/xposed/">Xposed</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/containerd/">containerd</a> <a class="post-tag" href="/tags/dma/">DMA</a> <a class="post-tag" href="/tags/docker/">docker</a>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav>
</div>
</div>
</div>
<div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
<div id="related-posts" class="mt-5 mb-2 mb-sm-4">
<h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3>
<div class="card-deck mb-4">
<div class="card"> <a href="/posts/Docker%E6%90%AD%E5%BB%BAPbootCMS%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%BD%91%E7%AB%99/"><div class="card-body"> <span class="timeago small"> Aug 9, 2020 <i class="unloaded">2020-08-09T10:31:41+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Docker 搭建 PbootCMS 内容管理网站</h3>
<div class="text-muted small"><p> Docker拉取需要用到的镜像 docker pull eboraas/apache-php docker pull mysql 克隆项目到本地 git clone https://gitee.com/hnaoyun/PbootCMS.git 启动一个 eboraas/apache-php 容器 docker run --name site -d -p 8080:80 -p...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/%E9%9D%92%E8%97%A4%E4%BA%91%E5%AE%89%E5%85%A8/"><div class="card-body"> <span class="timeago small"> Sep 5 <i class="unloaded">2022-09-05T17:49:23+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>青藤云安全</h3>
<div class="text-muted small"><p> # 自适应安全框架(ASA, Adaptive SecurityArchitecture) 是Gartner于2014年提出的面向下一代的安全体系架构, 以应对云大无移智时代所面临的安全形势。</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/%E9%9B%B6%E6%8B%B7%E8%B4%9D%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98/"><div class="card-body"> <span class="timeago small"> Aug 3 <i class="unloaded">2022-08-03T16:32:03+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>零拷贝相关问题</h3>
<div class="text-muted small"><p> 一、基础知识 物理内存：内存条。 虚拟内存：通过内存管理技术实现的一段连续完整的虚拟内存地址空间，可能实际在物理内存上的存储是碎片化分散的。 用户空间：系统划分给每个进程运行的虚拟内存地址空间范围，每个进程独享，进程间隔离，32位和64位范围不同，一般与内核空间成3:1的比例。 内核空间：系统划分给自身内核运行的虚拟内存地址空间范围，系统内核独享，进程间共享。 系统调...</p></div>
</div></a>
</div>
</div>
</div>
<div class="post-navigation d-flex justify-content-between"> <a href="/posts/%E9%9D%92%E8%97%A4%E4%BA%91%E5%AE%89%E5%85%A8/" class="btn btn-outline-primary" prompt="Older"><p>青藤云安全</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span>
</div>
</div></div></div>
<footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center">
<div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/LanXuage">LanXuage</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div>
<div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div>
</div></footer>
</div>
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content">
<div id="search-hints">
<h4 class="text-muted mb-4">Trending Tags</h4>
<a class="post-tag" href="/tags/adworld/">adworld</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/reverse/">reverse</a> <a class="post-tag" href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/">攻防世界</a> <a class="post-tag" href="/tags/android-studio/">Android Studio</a> <a class="post-tag" href="/tags/xposed/">Xposed</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/containerd/">containerd</a> <a class="post-tag" href="/tags/dma/">DMA</a> <a class="post-tag" href="/tags/docker/">docker</a>
</div>
<div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
</div></div>
</div>
<div id="mask"></div>
<a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
</body>
</html>
